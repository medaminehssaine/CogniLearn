<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: 'CogniLearn'">CogniLearn</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Custom Premium Theme -->
    <link href="/css/style.css" rel="stylesheet">

    <th:block th:replace="${extraStyles} ?: ~{}"></th:block>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <i class="bi bi-cpu-fill me-2 text-gradient"></i>
                <span>Cogni<span class="text-gradient">Learn</span></span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown"
                            role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-2"
                                style="width: 32px; height: 32px;">
                                <span class="text-white small fw-bold"
                                    th:text="${#authentication.name.substring(0,1).toUpperCase()}">U</span>
                            </div>
                            <span sec:authentication="name">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end glass-panel border-0">
                            <li><span class="dropdown-item-text text-muted small"
                                    sec:authorize="hasRole('ADMINISTRATOR')">Super Admin</span></li>
                            <li><span class="dropdown-item-text text-muted small"
                                    sec:authorize="hasRole('TEACHER')">Teacher</span></li>
                            <li><span class="dropdown-item-text text-muted small"
                                    sec:authorize="hasRole('STUDENT')">Student</span></li>
                            <li>
                                <hr class="dropdown-divider border-secondary">
                            </li>
                            <li>
                                <form th:action="@{/logout}" method="post" class="d-inline">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="bi bi-box-arrow-right me-2"></i>Logout
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid" style="margin-top: 70px;">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0 sidebar position-fixed h-100" sec:authorize="isAuthenticated()"
                style="z-index: 900;">
                <nav class="p-3 mt-3">
                    <!-- Super Admin Sidebar -->
                    <div sec:authorize="hasRole('ADMINISTRATOR')">
                        <h6 class="text-uppercase text-muted small mb-3 ps-3">Platform</h6>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" th:classappend="${currentPage == 'superadmin-dashboard'} ? 'active'"
                                    th:href="@{/superadmin/dashboard}">
                                    <i class="bi bi-shield-lock me-2"></i>Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" th:classappend="${currentPage == 'superadmin-teachers'} ? 'active'"
                                    th:href="@{/superadmin/teachers}">
                                    <i class="bi bi-person-badge me-2"></i>Teachers
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" th:classappend="${currentPage == 'superadmin-activity'} ? 'active'"
                                    th:href="@{/superadmin/activity}">
                                    <i class="bi bi-activity me-2"></i>Activity
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!-- Teacher Sidebar -->
                    <div sec:authorize="hasRole('TEACHER')">
                        <h6 class="text-uppercase text-muted small mb-3 ps-3">Teaching</h6>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" th:classappend="${currentPage == 'teacher-dashboard'} ? 'active'"
                                    th:href="@{/teacher/dashboard}">
                                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" th:classappend="${currentPage == 'teacher-courses'} ? 'active'"
                                    th:href="@{/teacher/courses}">
                                    <i class="bi bi-book me-2"></i>Courses
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" th:classappend="${currentPage == 'teacher-modules'} ? 'active'"
                                    th:href="@{/teacher/modules}">
                                    <i class="bi bi-folder me-2"></i>Modules
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" th:classappend="${currentPage == 'teacher-students'} ? 'active'"
                                    th:href="@{/teacher/students}">
                                    <i class="bi bi-people me-2"></i>Students
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!-- Student Sidebar -->
                    <div sec:authorize="hasRole('STUDENT')">
                        <h6 class="text-uppercase text-muted small mb-3 ps-3">Learning</h6>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" th:classappend="${currentPage == 'student-dashboard'} ? 'active'"
                                    th:href="@{/student/dashboard}">
                                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" th:classappend="${currentPage == 'student-courses'} ? 'active'"
                                    th:href="@{/student/courses}">
                                    <i class="bi bi-book me-2"></i>My Courses
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" th:classappend="${currentPage == 'student-quizzes'} ? 'active'"
                                    th:href="@{/student/quizzes}">
                                    <i class="bi bi-question-circle me-2"></i>Quizzes
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" th:classappend="${currentPage == 'student-history'} ? 'active'"
                                    th:href="@{/student/history}">
                                    <i class="bi bi-clock-history me-2"></i>History
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>

            <!-- Page Content -->
            <div class="col-md-9 col-lg-10 ms-auto content-wrapper p-4">
                <!-- Alerts -->
                <div th:if="${success}"
                    class="alert alert-success alert-dismissible fade show glass-panel text-white border-0" role="alert"
                    style="background: rgba(16, 185, 129, 0.2);">
                    <i class="bi bi-check-circle me-2"></i>
                    <span th:text="${success}"></span>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${error}"
                    class="alert alert-danger alert-dismissible fade show glass-panel text-white border-0" role="alert"
                    style="background: rgba(239, 68, 68, 0.2);">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span th:text="${error}"></span>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
                </div>

                <!-- Page Content Fragment -->
                <div class="fade-in">
                    <th:block th:replace="${content} ?: ~{}"></th:block>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Widget (Global) -->
    <div class="chat-widget" id="chatWidget" onclick="toggleChat()">
        <i class="bi bi-stars"></i>
    </div>

    <div class="chat-panel glass-panel" id="chatPanel">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-secondary">
            <div class="d-flex align-items-center gap-2">
                <div class="chat-avatar">
                    <i class="bi bi-cpu"></i>
                </div>
                <div>
                    <h6 class="m-0 text-white">CogniAI</h6>
                    <small class="text-success"><i class="bi bi-circle-fill me-1"
                            style="font-size: 0.5rem;"></i>Online</small>
                </div>
            </div>
            <button class="btn btn-sm btn-outline-light border-0" onclick="toggleChat()"><i
                    class="bi bi-x-lg"></i></button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <div class="message-content">
                    ðŸ‘‹ Hello! I'm <strong>CogniAI</strong>, your intelligent learning assistant. Ask me anything about
                    your courses!
                </div>
            </div>
        </div>
        <div class="p-3 border-top border-secondary">
            <div class="input-group">
                <input type="text" class="form-control border-0" id="chatInput" placeholder="Ask me anything..."
                    onkeypress="handleChatInput(event)">
                <button class="btn btn-primary px-4" onclick="sendMessage()"><i class="bi bi-send-fill"></i></button>
            </div>
        </div>
    </div>

    <style>
        .chat-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .message-content {
            line-height: 1.6;
        }

        .message-content strong {
            color: #8b5cf6;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 0.5rem 0;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #6366f1;
            border-radius: 50%;
            animation: typingBounce 1.4s ease-in-out infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.4;
            }

            30% {
                transform: translateY(-8px);
                opacity: 1;
            }
        }
    </style>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- KaTeX Auto-render -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        { left: '$$', right: '$$', display: true },
                        { left: '$', right: '$', display: false },
                        { left: '\\(', right: '\\)', display: false },
                        { left: '\\[', right: '\\]', display: true }
                    ],
                    throwOnError: false,
                    trust: true
                });
            }
        });

        // Chat Widget Logic
        function toggleChat() {
            document.getElementById('chatPanel').classList.toggle('active');
        }

        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            input.value = '';

            // Add typing indicator
            const chatMessages = document.getElementById('chatMessages');
            const typingId = 'typing-' + Date.now();
            const typingHtml = `
                <div class="message ai" id="${typingId}">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.insertAdjacentHTML('beforeend', typingHtml);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Call API
            fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById(typingId).remove();
                    addMessage(data.response, 'ai');
                })
                .catch(error => {
                    document.getElementById(typingId).remove();
                    addMessage("I'm having trouble connecting right now. Please try again later.", 'ai');
                });
        }

        function addMessage(text, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = text.replace(/\n/g, '<br>');

            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
    <th:block th:replace="${extraScripts} ?: ~{}"></th:block>
</body>

</html>