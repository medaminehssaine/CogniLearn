<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout :: html(pageTitle='Quiz Result', content=~{::content}, extraStyles=~{::extraStyles}, extraScripts=~{::extraScripts})}">

<head>
    <th:block th:fragment="extraStyles">
        <style>
            .result-container {
                max-width: 1000px;
                margin: 0 auto;
            }

            .result-header-card {
                background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 24px;
                padding: 3rem 2rem;
                position: relative;
                overflow: hidden;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            }

            .result-header-card::before {
                content: '';
                position: absolute;
                top: -50%;
                right: -10%;
                width: 400px;
                height: 400px;
                background: radial-gradient(circle, rgba(99, 102, 241, 0.15), transparent 70%);
                border-radius: 50%;
                z-index: 0;
            }

            .score-circle-wrapper {
                position: relative;
                width: 200px;
                height: 200px;
                margin: 0 auto;
            }

            .score-circle {
                width: 100%;
                height: 100%;
                border-radius: 50%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                position: relative;
                z-index: 2;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(10px);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }

            .score-circle::before {
                content: '';
                position: absolute;
                inset: -5px;
                border-radius: 50%;
                padding: 5px;
                background: conic-gradient(from 0deg, var(--score-color), transparent 80%);
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: xor;
                mask-composite: exclude;
                animation: spin 4s linear infinite;
            }

            @keyframes spin {
                from {
                    --angle: 0deg;
                }

                to {
                    --angle: 360deg;
                }
            }

            .score-value {
                font-size: 3.5rem;
                font-weight: 800;
                line-height: 1;
                background: linear-gradient(135deg, #fff, #cbd5e1);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            .score-label {
                text-transform: uppercase;
                letter-spacing: 2px;
                font-size: 0.8rem;
                color: #94a3b8;
                margin-top: 0.5rem;
            }

            .stat-box {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 16px;
                padding: 1.5rem;
                text-align: center;
                transition: transform 0.3s;
            }

            .stat-box:hover {
                transform: translateY(-5px);
                background: rgba(255, 255, 255, 0.08);
            }

            .question-result-card {
                background: rgba(30, 41, 59, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: 16px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                transition: all 0.3s;
            }

            .question-result-card:hover {
                background: rgba(30, 41, 59, 0.8);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .question-result-card.correct {
                border-left: 4px solid #10b981;
            }

            .question-result-card.incorrect {
                border-left: 4px solid #ef4444;
            }

            .option-result {
                padding: 1rem;
                border-radius: 12px;
                margin-bottom: 0.5rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: rgba(255, 255, 255, 0.02);
                border: 1px solid transparent;
            }

            .option-result.correct-answer {
                background: rgba(16, 185, 129, 0.1);
                border-color: rgba(16, 185, 129, 0.3);
            }

            .option-result.wrong-selection {
                background: rgba(239, 68, 68, 0.1);
                border-color: rgba(239, 68, 68, 0.3);
            }

            .ai-feedback-box {
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
                border: 1px solid rgba(99, 102, 241, 0.2);
                border-radius: 16px;
                padding: 1.5rem;
                margin-top: 2rem;
            }

            .explain-btn {
                background: rgba(99, 102, 241, 0.1);
                color: #818cf8;
                border: 1px solid rgba(99, 102, 241, 0.2);
                border-radius: 8px;
                padding: 0.4rem 1rem;
                font-size: 0.85rem;
                transition: all 0.2s;
            }

            .explain-btn:hover {
                background: rgba(99, 102, 241, 0.2);
                color: #fff;
                transform: translateY(-2px);
            }
        </style>
    </th:block>
</head>

<body>
    <div th:fragment="content">
        <div class="result-container">
            <!-- Breadcrumb -->
            <div class="mb-4 fade-in">
                <a th:href="@{/student/courses/{id}(id=${quiz.course.id})}"
                    class="text-decoration-none text-muted hover-arrow">
                    <i class="bi bi-arrow-left me-1"></i> Back to Course
                </a>
            </div>

            <!-- Result Header -->
            <div class="result-header-card mb-5 fade-in">
                <div class="row align-items-center">
                    <div class="col-lg-4 text-center mb-4 mb-lg-0">
                        <div class="score-circle-wrapper"
                            th:style="'--score-color: ' + (${result.passed} ? '#10b981' : '#ef4444')">
                            <div class="score-circle">
                                <div class="score-value"
                                    th:text="${#numbers.formatDecimal(result.scorePercentage, 1, 0)} + '%'">85%</div>
                                <div class="score-label">Final Score</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="ps-lg-4">
                            <h2 class="display-6 fw-bold text-white mb-2" th:if="${result.passed}">
                                <i class="bi bi-trophy-fill text-warning me-2"></i>Outstanding Job!
                            </h2>
                            <h2 class="display-6 fw-bold text-white mb-2" th:unless="${result.passed}">
                                <i class="bi bi-graph-up-arrow text-info me-2"></i>Keep Practicing!
                            </h2>

                            <div class="ai-feedback-box mb-4">
                                <div class="d-flex align-items-center gap-2 mb-2 text-primary">
                                    <i class="bi bi-stars"></i>
                                    <span class="fw-bold small text-uppercase">AI Analysis</span>
                                </div>
                                <p class="mb-0 text-light" style="line-height: 1.6;" th:text="${result.agentFeedback}">
                                    AI Feedback here...</p>
                            </div>

                            <div class="row g-3">
                                <div class="col-4">
                                    <div class="stat-box">
                                        <div class="h3 mb-0 text-white"
                                            th:text="${result.correctAnswers} + '/' + ${result.totalQuestions}">4/5
                                        </div>
                                        <small class="text-muted text-uppercase"
                                            style="font-size: 0.7rem;">Correct</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-box">
                                        <div class="h3 mb-0 text-white"
                                            th:text="${(result.timeTakenSeconds / 60)} + 'm ' + ${(result.timeTakenSeconds % 60)} + 's'">
                                            2m 30s</div>
                                        <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Time</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-box">
                                        <div class="h3 mb-0 text-white" th:text="${result.recommendedNextDifficulty}">
                                            MEDIUM</div>
                                        <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Next
                                            Level</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="d-flex justify-content-between align-items-center mb-4 fade-in fade-in-delay-1">
                        <h4 class="text-white mb-0"><i class="bi bi-journal-check me-2 text-primary"></i>Review Answers
                        </h4>
                        <button class="btn btn-outline-light btn-sm" onclick="expandAll()">
                            <i class="bi bi-arrows-expand me-1"></i> Expand All
                        </button>
                    </div>

                    <div th:each="question, iterStat : ${questions}"
                        class="question-result-card fade-in fade-in-delay-2" th:classappend="${#lists.contains(result.studentAnswers.![questionId], question.id) ? 
                         (#lists.contains(result.studentAnswers.?[questionId == #root.question.id and correct == true].![questionId], question.id) ? 'correct' : 'incorrect') : 
                         'incorrect'}">

                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex align-items-center gap-3">
                                <span
                                    class="badge bg-dark border border-secondary text-muted">Q[[${iterStat.count}]]</span>
                                <th:block
                                    th:with="studentAnswer=${result.studentAnswers.?[questionId == #root.question.id]}">
                                    <span th:if="${!#lists.isEmpty(studentAnswer) && studentAnswer[0].correct}"
                                        class="text-success fw-bold small">
                                        <i class="bi bi-check-circle-fill me-1"></i> Correct
                                    </span>
                                    <span th:unless="${!#lists.isEmpty(studentAnswer) && studentAnswer[0].correct}"
                                        class="text-danger fw-bold small">
                                        <i class="bi bi-x-circle-fill me-1"></i> Incorrect
                                    </span>
                                </th:block>
                            </div>
                            <button class="explain-btn" th:onclick="'explainQuestion(' + ${iterStat.count} + ')'">
                                <i class="bi bi-stars me-1"></i> Explain with AI
                            </button>
                        </div>

                        <h5 class="text-white mb-3 math-content" th:text="${question.questionText}"
                            th:id="'q-text-' + ${iterStat.count}">Question?</h5>

                        <div class="options-list">
                            <div th:each="option, optStat : ${question.options}" class="option-result"
                                th:with="studentAnswer=${result.studentAnswers.?[questionId == #root.question.id]}"
                                th:classappend="${optStat.index == question.correctOptionIndex ? 'correct-answer' : 
                                           (!#lists.isEmpty(studentAnswer) && studentAnswer[0].selectedOptionIndex == optStat.index && optStat.index != question.correctOptionIndex ? 'wrong-selection' : '')}">

                                <div class="d-flex align-items-center gap-3">
                                    <span class="fw-bold text-muted"
                                        th:text="${#strings.concat('ABCD'.charAt(optStat.index))}">A</span>
                                    <span class="text-light math-content" th:text="${option.optionText}">Option</span>
                                </div>

                                <div th:if="${optStat.index == question.correctOptionIndex}">
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                </div>
                                <div
                                    th:if="${!#lists.isEmpty(studentAnswer) && studentAnswer[0].selectedOptionIndex == optStat.index && optStat.index != question.correctOptionIndex}">
                                    <i class="bi bi-x-circle-fill text-danger"></i>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-top border-secondary border-opacity-25"
                            th:if="${question.explanation}">
                            <p class="small text-muted mb-1 text-uppercase fw-bold">Explanation</p>
                            <p class="text-light small mb-0 math-content" th:text="${question.explanation}">Explanation
                                text...</p>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card glass-panel border-0 mb-4 sticky-top fade-in fade-in-delay-1"
                        style="top: 90px; z-index: 90;">
                        <div class="card-body">
                            <h5 class="text-white mb-4">What's Next?</h5>
                            <div class="d-grid gap-3">
                                <a th:href="@{/student/courses/{id}(id=${quiz.course.id})}"
                                    class="btn btn-primary py-3">
                                    <i class="bi bi-arrow-repeat me-2"></i>Take Another Quiz
                                </a>
                                <a th:href="@{/student/courses/{id}(id=${quiz.course.id})}"
                                    class="btn btn-outline-light py-3">
                                    <i class="bi bi-book me-2"></i>Review Course Material
                                </a>
                                <a th:href="@{/student/history}" class="btn btn-outline-secondary py-3">
                                    <i class="bi bi-clock-history me-2"></i>View History
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block th:fragment="extraScripts">
        <script>
            function explainQuestion(questionIndex) {
                const questionText = document.getElementById('q-text-' + questionIndex).innerText;
                const message = "Can you explain this question: \"" + questionText + "\"? I'd like to understand the correct answer better.";

                // Open chat panel
                const chatPanel = document.getElementById('chatPanel');
                if (!chatPanel.classList.contains('active')) {
                    toggleChat();
                }

                // Populate input and send
                const input = document.getElementById('chatInput');
                input.value = message;
                sendMessage();
            }

            function expandAll() {
                // Logic to expand all explanations if they were collapsible (currently they are always visible)
                // Could scroll to first question
                document.querySelector('.question-result-card').scrollIntoView({ behavior: 'smooth' });
            }
        </script>
    </th:block>
</body>

</html>